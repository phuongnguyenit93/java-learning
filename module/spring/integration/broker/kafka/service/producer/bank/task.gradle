apply from: "${rootDir}/gradle/config/env.gradle"
apply from: "${rootDir}/gradle/config/readme.gradle"
apply from: "${rootDir}/gradle/config/properties.gradle"

// Injected: combineEnvByServiceNameAndProfile

tasks.register("combineEnvByServiceNameAndProfile_KAFKA_PRODUCER_BANK", DefaultTask) {
    String serviceNameProp = project.findProperty("SERVICE_NAME")?.toString()
    if (serviceNameProp?.toString()?.blank) {
        throw new GradleException("Error : Missing 'SERVICE_NAME'. Please add by -PSERVICE_NAME=... or in gradle.properties")
    }

    String profileStr = project.findProperty("PROFILE")?.toString()
    List<HashMap> folderPropsList = gradle.extensions.getExtraProperties().get("allFolderProps") as List<HashMap>

    project.ext.combineEnvByServiceNameAndProfile (folderPropsList,serviceNameProp,profileStr)
}

// Injected: buildFinalReadmeByServiceName

tasks.register("buildFinalReadmeByServiceName_KAFKA_PRODUCER_BANK", DefaultTask) {
    String serviceNameProp = project.findProperty("SERVICE_NAME")?.toString()
    if (serviceNameProp?.toString()?.blank) {
        throw new GradleException("Error : Missing 'SERVICE_NAME'. Please add by -PSERVICE_NAME=... or in gradle.properties")
    }

    List<HashMap> folderPropsList = gradle.extensions.getExtraProperties().get("allFolderProps") as List<HashMap>

    project.ext.buildReadmeByServiceName (folderPropsList,serviceNameProp)
}

// Injected: combineBuildYaml

tasks.register("combineBuildYaml_KAFKA_PRODUCER_BANK", DefaultTask) {
    outputs.upToDateWhen { false }
    doLast {
        String serviceNameProp = project.findProperty("SERVICE_NAME")?.toString()
        if (serviceNameProp?.toString()?.blank) {
            throw new GradleException("Error : Missing 'SERVICE_NAME'. Please add by -PSERVICE_NAME=... or in gradle.properties")
        }

        List<HashMap> folderPropsList = gradle.extensions.getExtraProperties().get("allFolderProps") as List<HashMap>

        project.ext.combineBuildYaml (folderPropsList,serviceNameProp)
    }
}

tasks.named('processResources') {
    finalizedBy "combineBuildYaml_KAFKA_PRODUCER_BANK"
}

tasks.named('bootJar') {
    dependsOn "combineBuildYaml_KAFKA_PRODUCER_BANK"
}

