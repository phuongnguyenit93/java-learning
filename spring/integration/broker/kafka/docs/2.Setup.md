## H∆∞·ªõng d·∫´n setup v√† build 1 project Kafka

### 1. Setup Kafka v·ªõi Docker Compose

S·ª≠ d·ª•ng `docker-compose` l√† c√°ch nhanh nh·∫•t ƒë·ªÉ kh·ªüi t·∫°o Kafka ph·ª•c v·ª• cho m√¥i tr∆∞·ªùng **local development**.

#### Y√™u c·∫ßu
- Docker
- Docker Compose

#### C·∫•u tr√∫c th∆∞ m·ª•c
```text
project-root
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ README.md
```
### Docker Compose Configuration

S·ª≠ d·ª•ng Docker Compose ƒë·ªÉ kh·ªüi t·∫°o Kafka ch·∫°y ·ªü ch·∫ø ƒë·ªô **KRaft (kh√¥ng c·∫ßn ZooKeeper)**.

#### File `docker-compose.yml`

```yaml
version: '3.8'

services:
  kafka1:
    image: apache/kafka:latest
    container_name: kafka1
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka1:29093,2@kafka2:29093,3@kafka3:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://:29092,CONTROLLER://:29093,PLAINTEXT_HOST://:9092'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka1:29092,PLAINTEXT_HOST://localhost:9092'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3 # TƒÉng l√™n 3 ƒë·ªÉ an to√†n d·ªØ li·ªáu
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'false'

  kafka2:
    image: apache/kafka:latest
    container_name: kafka2
    ports:
      - "9093:9093"
    environment:
      KAFKA_NODE_ID: 2
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka1:29093,2@kafka2:29093,3@kafka3:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://:29092,CONTROLLER://:29093,PLAINTEXT_HOST://:9093'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka2:29092,PLAINTEXT_HOST://localhost:9093'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'false'

  kafka3:
    image: apache/kafka:latest
    container_name: kafka3
    ports:
      - "9094:9094"
    environment:
      KAFKA_NODE_ID: 3
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka1:29093,2@kafka2:29093,3@kafka3:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://:29092,CONTROLLER://:29093,PLAINTEXT_HOST://:9094'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka3:29092,PLAINTEXT_HOST://localhost:9094'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'false'

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    depends_on:
      - kafka1
      - kafka2
      - kafka3
    environment:
      # K·∫øt n·ªëi Kafka UI v·ªõi service 'kafka' b√™n tr√™n
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka1:29092,kafka2:29092,kafka3:29092
      DYNAMIC_CONFIG_ENABLED: 'true'

```

Gi·∫£i th√≠ch m·ªôt s·ªë properties trong docker compose :
### 1. ƒê·ªãnh danh v√† Vai tr√≤ (Identification & Roles)

#### KAFKA_NODE_ID: 1
* ID duy nh·∫•t c·ªßa broker trong c·ª•m.
* C√°c node kh√°c ph·∫£i l√† 2, 3...
* N√≥ thay th·∫ø cho broker.id tr∆∞·ªõc ƒë√¢y.

#### KAFKA_PROCESS_ROLES: 'broker,controller'
* X√°c ƒë·ªãnh node n√†y l√†m nhi·ªám v·ª• g√¨.
* broker: L∆∞u tr·ªØ d·ªØ li·ªáu v√† x·ª≠ l√Ω y√™u c·∫ßu t·ª´ client.
* controller: Qu·∫£n l√Ω c·ª•m (thay th·∫ø vai tr√≤ c·ªßa Zookeeper). M·ªôt node c√≥ th·ªÉ l√†m c·∫£ hai.

üìå C√≥ 3 ki·ªÉu:
* broker
* controller
* broker,controller (ph·ªï bi·∫øn cho dev)

#### CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
* ID c·ªßa c·∫£ c·ª•m.
* T·∫•t c·∫£ c√°c broker trong c√πng m·ªôt c·ª•m ph·∫£i d√πng chung ID n√†y ƒë·ªÉ ch√∫ng nh·∫≠n di·ªán ƒë∆∞·ª£c nhau.
---
### 2. C∆° ch·∫ø B·∫ßu ch·ªçn (Quorum Configuration)

#### KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka1:29093,2@kafka2:29093,3@kafka3:29093'
* Danh s√°ch c√°c node c√≥ quy·ªÅn bi·ªÉu quy·∫øt ƒë·ªÉ b·∫ßu ra "Leader" qu·∫£n l√Ω c·ª•m.
* ƒê·ªãnh d·∫°ng l√† node_id@host_name:port_controller.
* ƒê√¢y l√† c√°ch c√°c controller t√¨m th·∫•y nhau ƒë·ªÉ duy tr√¨ s·ª± ·ªïn ƒë·ªãnh c·ªßa c·ª•m.

### 3. M·∫°ng v√† K·∫øt n·ªëi (Listeners) - ƒê√¢y l√† ph·∫ßn d·ªÖ g√¢y nh·∫ßm l·∫´n nh·∫•t:

#### KAFKA_LISTENERS: 'PLAINTEXT://:29092,CONTROLLER://:29093,PLAINTEXT_HOST://:9092'

- Khai b√°o c√°c "c·ªïng" m√† Kafka s·∫Ω m·ªü ra ƒë·ªÉ l·∫Øng nghe.

    * PLAINTEXT://:29092: Cho c√°c broker kh√°c ho·∫∑c app trong Docker (Broker n·ªôi b·ªô (container ‚Üî container))
    * CONTROLLER://:29093: Ch·ªâ d√†nh cho c√°c controller trao ƒë·ªïi th√¥ng tin b·∫ßu ch·ªçn.
    * PLAINTEXT_HOST://:9092: Cho c√°c ·ª©ng d·ª•ng ch·∫°y b√™n ngo√†i Docker (localhost).
- Listener ch·ªâ l√† c·ªïng m·ªü, ch∆∞a ph·∫£i ƒë·ªãa ch·ªâ client th·∫•y

#### KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka3:29092,PLAINTEXT_HOST://localhost:9092'

* ƒê·ªãa ch·ªâ m√† Kafka "qu·∫£ng b√°" ra ngo√†i.
* Khi client k·∫øt n·ªëi t·ªõi Kafka, Kafka s·∫Ω g·ª≠i l·∫°i ƒë·ªãa ch·ªâ n√†y ƒë·ªÉ b·∫£o client h√£y li√™n l·∫°c qua ƒë√≥.
* Client ngo√†i Docker s·∫Ω d√πng localhost:9092.
* Client trong Docker (nh∆∞ Kafka UI) s·∫Ω d√πng kafka1:29092.

#### KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
* ƒê·ªãnh nghƒ©a giao th·ª©c b·∫£o m·∫≠t cho t·ª´ng t√™n listener.
* ·ªû ƒë√¢y t·∫•t c·∫£ ƒë·ªÅu l√† PLAINTEXT (kh√¥ng m√£ h√≥a).
* N·∫øu d√πng SSL/SASL th√¨ config t·∫°i ƒë√¢y

### 4. Giao ti·∫øp n·ªôi b·ªô (Internal Communication)

#### KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER':
* Ch·ªâ ƒë·ªãnh listener n√†o ƒë∆∞·ª£c d√πng cho m·ª•c ƒë√≠ch qu·∫£n l√Ω c·ª•m (controller).
* B·∫Øt bu·ªôc trong KRaft mode

#### KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT':
* Ch·ªâ ƒë·ªãnh listener n√†o ƒë∆∞·ª£c c√°c broker d√πng ƒë·ªÉ sao ch√©p d·ªØ li·ªáu qua l·∫°i v·ªõi nhau.
* Listener d√πng cho:
    * Broker ‚Üî Broker
    * Replication
    * Metadata sync
* Kh√¥ng ph·∫£i client listener

### 5. C·∫•u h√¨nh h·ªá th·ªëng v√† D·ªØ li·ªáu

#### KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3:
* Kafka l∆∞u v·ªã tr√≠ (offset) ƒë√£ ƒë·ªçc c·ªßa c√°c Consumer trong m·ªôt topic n·ªôi b·ªô. Khi c√≥ 3 broker, ta ƒë·∫∑t l√† 3 ƒë·ªÉ n·∫øu 2 broker ch·∫øt, ta v·∫´n kh√¥ng m·∫•t d·∫•u v·∫øt ƒëang ƒë·ªçc ƒë·∫øn ƒë√¢u.

#### KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'false':
* T·∫Øt t√≠nh nƒÉng t·ª± t·∫°o topic ƒë·ªÉ ki·ªÉm so√°t ch·∫∑t ch·∫Ω h·ªá th·ªëng.

#### KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1 & REPLICATION_FACTOR: 1:
* C·∫•u h√¨nh cho c√°c b·∫£n ghi giao d·ªãch (transactions).
* Trong m√¥i tr∆∞·ªùng 3 broker, b·∫°n n√™n n√¢ng REPLICATION_FACTOR l√™n 3 ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi s·ªë l∆∞·ª£ng broker.

--- 
T√≥m t·∫Øt lu·ªìng ƒëi c·ªßa d·ªØ li·ªáu:

* Spring Boot (ngo√†i Docker) nh√¨n th·∫•y localhost:9092 (PLAINTEXT_HOST).
* Kafka UI (trong Docker) nh√¨n th·∫•y kafka1:29092 (PLAINTEXT).
* C√°c Broker b·∫ßu ch·ªçn l·∫´n nhau qua c·ªïng 29093 (CONTROLLER).

## Kh·ªüi ƒë·ªông Kafka
```bash
docker-compose up -d
```

