# CÃ¡c kiáº¿n thá»©c nÃ¢ng cao cá»§a Kafka
## Idempotent

### Äá»‹nh nghÄ©a 
Idempotent Producer lÃ  cÆ¡ cháº¿ giÃºp Kafka Producer **khÃ´ng gá»­i trÃ¹ng message**, ká»ƒ cáº£ khi pháº£i retry do:
- Network error
- Timeout
- Leader failover

ğŸ‘‰ Gá»­i 1 láº§n hay retry 10 láº§n â†’ **Broker chá»‰ ghi Ä‘Ãºng 1 message**

---

### Váº¥n Ä‘á» Kafka gáº·p pháº£i (trÆ°á»›c khi cÃ³ idempotent)

Kafka khuyáº¿n khÃ­ch retry Ä‘á»ƒ trÃ¡nh máº¥t message, nhÆ°ng retry cÃ³ thá»ƒ gÃ¢y **duplicate**:

* Producer gá»­i message â†’ Broker ghi OK  
* ACK bá»‹ máº¥t (timeout / network)  
* Producer retry  
* Broker ghi **láº§n ná»¯a** âŒ

â¡ Consumer Ä‘á»c â†’ xá»­ lÃ½ **trÃ¹ng dá»¯ liá»‡u**

---

## How It Works

Kafka gáº¯n cho má»—i producer:

- **ProducerId (PID)** â€“ duy nháº¥t
- **Sequence Number** â€“ tÄƒng dáº§n theo tá»«ng partition

Broker sáº½:
- LÆ°u sequence cuá»‘i cÃ¹ng cá»§a `PID + partition`
- Bá» qua message cÃ³ sequence Ä‘Ã£ xá»­ lÃ½
- Reject message cÃ³ sequence sai thá»© tá»±

â¡ Retry bao nhiÃªu láº§n cÅ©ng **khÃ´ng bá»‹ duplicate**

---

### Configuration

#### Kafka Producer

```properties
enable.idempotence=true
```

Spring Kafka

```properties
spring.kafka.producer.properties.enable.idempotence: true
```
### Enforced Configs

Khi báº­t `idempotence`, Kafka **tá»± Ä‘á»™ng Ã©p cÃ¡c config an toÃ n** Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng máº¥t tÃ­nh idempotent:

| Config | Value |
|------|------|
| `acks` | `all` |
| `retries` | `> 0` |
| `max.in.flight.requests.per.connection` | `â‰¤ 5` |

---

## Limitations

âŒ **KhÃ´ng Ä‘áº£m báº£o exactly-once end-to-end**

Idempotent Producer **chá»‰ Ä‘áº£m báº£o**:
- Exactly-once giá»¯a **Producer â†’ Broker**

âŒ **KhÃ´ng Ä‘áº£m báº£o**:
- Consumer xá»­ lÃ½ Ä‘Ãºng 1 láº§n
- Database khÃ´ng bá»‹ ghi trÃ¹ng

ğŸ‘‰ Muá»‘n end-to-end exactly-once â†’ **Kafka Transactions**

---

## Comparison

| Mechanism | Deduplication | Scope |
|---------|---------------|-------|
| Normal Retry | âŒ | None |
| Idempotent Producer | âœ… | Producer â†’ Broker |
| Kafka Transactions | âœ… | Producer â†’ Broker â†’ Consumer |

---

## Khi nÃ o Báº®T BUá»˜C nÃªn dÃ¹ng?

### NÃªn báº­t gáº§n nhÆ° má»i producer hiá»‡n Ä‘áº¡i, Ä‘áº·c biá»‡t khi:
- Producer cÃ³ retry
- Xá»­ lÃ½ **tÃ i chÃ­nh / Ä‘Æ¡n hÃ ng**
- Dá»¯ liá»‡u **khÃ´ng Ä‘Æ°á»£c phÃ©p trÃ¹ng**

### KhÃ´ng báº­t chá»‰ khi:
- Dá»¯ liá»‡u cháº¥p nháº­n duplicate
- Kafka < 0.11

---
## ğŸ¯ Kafka Producer Retry â€“ Chuáº©n & An ToÃ n

## 1ï¸âƒ£ NguyÃªn táº¯c VÃ€NG

> **Kafka Producer: retry â‰  duplicate**  
> Duplicate **chá»‰ xáº£y ra** khi retry mÃ  **KHÃ”NG báº­t idempotent**

ğŸ‘‰ VÃ¬ váº­y:
- âœ… **Retry luÃ´n nÃªn báº­t**
- âœ… **Idempotent gáº§n nhÆ° luÃ´n nÃªn báº­t**

---

## 2ï¸âƒ£ Cáº¥u hÃ¬nh retry CHUáº¨N (Recommended)

### Kafka Client / Spring Kafka (99% trÆ°á»ng há»£p)

```properties
enable.idempotence=true
acks=all
retries=Integer.MAX_VALUE
delivery.timeout.ms=120000
linger.ms=5
batch.size=16384
```

Spring Boot
```yaml
spring:
  kafka:
    producer:
      acks: all
      retries: 2147483647
      properties:
        enable.idempotence: true
        delivery.timeout.ms: 120000

```

## 3ï¸âƒ£ Giáº£i thÃ­ch tá»«ng config (ngáº¯n gá»n)

### ğŸ” retries

- Cho phÃ©p retry gáº§n nhÆ° vÃ´ háº¡n
- Producer **chá»‰ fail khi**:
  - VÆ°á»£t `delivery.timeout.ms`
  - Hoáº·c gáº·p lá»—i **khÃ´ng thá»ƒ recover**

ğŸ“Œ Retry **KHÃ”NG gÃ¢y duplicate** náº¿u báº­t idempotent

---

### â± delivery.timeout.ms (Ráº¤T quan trá»ng)

- Tá»•ng thá»i gian Kafka cho phÃ©p:

send â†’ retry â†’ retry â†’ retry â†’ fail
â›” Náº¿u **KHÃ”NG set**:
- Retry nhiá»u
- NhÆ°ng timeout sá»›m â†’ **fail oan**

---

### âœ… acks=all

- Leader + toÃ n bá»™ ISR ghi xong má»›i ACK
- Cháº­m hÆ¡n má»™t chÃºt
- NhÆ°ng **khÃ´ng máº¥t dá»¯ liá»‡u**

ğŸ“Œ Kafka **báº¯t buá»™c `acks=all`** khi báº­t idempotent

---

### ğŸš¦ max.in.flight.requests.per.connection

- Kafka tá»± set `â‰¤ 5` khi `enable.idempotence=true`
- Äáº£m báº£o:
- Thá»© tá»± message
- Sequence number khÃ´ng bá»‹ lá»‡ch

âš ï¸ **KhÃ´ng override** giÃ¡ trá»‹ nÃ y

---

## 4ï¸âƒ£ Flow retry (thá»±c táº¿)
```
Producer gá»­i msg #10 (seq=10)
    â†“
Network timeout
    â†“
Retry gá»­i láº¡i msg #10 (seq=10)
    â†“
Broker tháº¥y seq=10 Ä‘Ã£ xá»­ lÃ½
    â†“
âŒ Bá» qua
    â†“
ACK OK
```

â¡â¡ï¸ KhÃ´ng duplicate  
â¡ï¸ Consumer chá»‰ tháº¥y **1 message**

---

## 5ï¸âƒ£ CÃ¡c lá»—i config PHá»” BIáº¾N (âš ï¸ cá»±c nguy hiá»ƒm)

### âŒ Retry nhÆ°ng KHÃ”NG báº­t idempotent

ğŸ’¥ **Duplicate cháº¯c cháº¯n xáº£y ra**

---

### âŒ Retry tháº¥p + timeout tháº¥p

â¡ï¸ Dá»… **máº¥t message** khi leader fail

---

### âŒ Táº¯t retry vÃ¬ â€œsá»£ trÃ¹ngâ€

â¡ï¸ **Máº¤T Dá»® LIá»†U** cÃ²n nguy hiá»ƒm hÆ¡n duplicate

---

## 6ï¸âƒ£ TÃ³m táº¯t nhanh

### âœ… LUÃ”N báº­t
```properties
enable.idempotence=true
acks=all
retries=Integer.MAX_VALUE
delivery.timeout.ms >= 120000
```
âŒ KHÃ”NG lÃ m

* Táº¯t retry
* Retry mÃ  khÃ´ng báº­t idempotent
* Override max.in.flight.requests.per.connection bá»«a bÃ£i


---
## Exactly-once, At-least-once, At-most-once

Máº·c Ä‘á»‹nh thÃ¬ : Kafka = at-least-once

### 1ï¸âƒ£ Tá»•ng quan nhanh (Báº£ng nhá»› nÃ£o ğŸ§ )

| Thuáº­t ngá»¯ | Ã nghÄ©a thá»±c táº¿ | CÃ³ máº¥t message? | CÃ³ xá»­ lÃ½ trÃ¹ng? | Äá»™ khÃ³ |
|---------|----------------|-----------------|-----------------|--------|
| **At-most-once** *(mostly-once)* | Xá»­ lÃ½ tá»‘i Ä‘a 1 láº§n | âœ… CÃ³ thá»ƒ | âŒ KhÃ´ng | Dá»… |
| **At-least-once** | Xá»­ lÃ½ Ã­t nháº¥t 1 láº§n | âŒ KhÃ´ng | âœ… CÃ³ thá»ƒ | Trung bÃ¬nh |
| **Exactly-once** | Xá»­ lÃ½ chÃ­nh xÃ¡c 1 láº§n | âŒ KhÃ´ng | âŒ KhÃ´ng | KhÃ³  |

ğŸ“Œ **Kafka máº·c Ä‘á»‹nh = At-least-once**

---

### 2ï¸âƒ£ At-most-once (Mostly-once) lÃ  gÃ¬?

#### ğŸ‘‰ Ã nghÄ©a
Message **cÃ³ thá»ƒ bá»‹ máº¥t**, nhÆ°ng **khÃ´ng bao giá» xá»­ lÃ½ trÃ¹ng**.

#### ğŸ‘‰ Khi nÃ o xáº£y ra?
- Commit offset **trÆ°á»›c khi xá»­ lÃ½**
- Consumer crash **sau commit**
- Kafka nghÄ©: *â€œxong rá»“iâ€*
- NhÆ°ng code **chÆ°a xá»­ lÃ½ xong**

#### ğŸ‘‰ Flow
```text
poll()
commit offset
process message ğŸ’¥ crash
```
â¡ï¸ **Message biáº¿n máº¥t vÄ©nh viá»…n**

#### ğŸ‘‰ DÃ¹ng khi nÃ o?
- Log
- Metric
- Tracking khÃ´ng quan trá»ng
- â€œMáº¥t 1â€“2 record khÃ´ng saoâ€

---

### 3ï¸âƒ£ At-least-once (Máº·c Ä‘á»‹nh Kafka)

#### ğŸ‘‰ Ã nghÄ©a
Message **khÃ´ng máº¥t**, nhÆ°ng **cÃ³ thá»ƒ xá»­ lÃ½ trÃ¹ng**.

#### ğŸ‘‰ Flow
```text
poll()
process message
commit offset
```
ğŸ’¥ Náº¿u crash trÆ°á»›c commit

â¡ï¸ Kafka gá»­i láº¡i message  
â¡ï¸ Message xá»­ lÃ½ **2 láº§n**

#### ğŸ‘‰ VÃ­ dá»¥ thá»±c táº¿
- Insert DB â†’ insert trÃ¹ng
- Gá»­i email â†’ gá»­i **2 láº§n** 

#### ğŸ‘‰ CÃ¡ch xá»­ lÃ½
- Idempotent
- Deduplicate
- Check business key

---

### 4ï¸âƒ£ Exactly-once lÃ  gÃ¬?

#### ğŸ‘‰ Ã nghÄ©a
DÃ¹ crash á»Ÿ Ä‘Ã¢u â†’ message **chá»‰ Ä‘Æ°á»£c xá»­ lÃ½ Ä‘Ãºng 1 láº§n**.

#### ğŸ‘‰ Váº¥n Ä‘á» cá»‘t lÃµi
Kafka **quáº£n lÃ½ Ä‘Æ°á»£c**:
- Offset
- Producer

âŒ **KHÃ”NG quáº£n lÃ½ Ä‘Æ°á»£c**:
- Database
- API
- Há»‡ thá»‘ng khÃ¡c

---

### 5ï¸âƒ£ Exactly-once trong Kafka nghÄ©a lÃ  gÃ¬ ?

âš ï¸ **Ráº¥t quan trá»ng**:

> **Kafka Exactly-once â‰  End-to-End Exactly-once**

Kafka **chá»‰ Ä‘áº£m báº£o**:
- Consume â†’ Process â†’ Produce sang **topic khÃ¡c** = Ä‘Ãºng 1 láº§n

ğŸ“Œ **KHÃ”NG Ä‘áº£m báº£o**:
- Ghi DB
- Call REST
- Gá»­i email

---

### 6ï¸âƒ£ Kafka lÃ m Exactly-once báº±ng cÃ¡ch nÃ o?

#### ğŸ”¹ Kafka Transaction
- `transactional.id`
- Commit offset + produce message trong **1 transaction**

```text
enable.idempotence=true
transactional.id=order-tx-1
```

```text
beginTransaction
consume message
produce new message
sendOffsetsToTransaction
commitTransaction
```

â¡ï¸ Hoáº·c **thÃ nh cÃ´ng háº¿t**  
â¡ï¸ Hoáº·c **rollback háº¿t**

---

### 7ï¸âƒ£ NhÆ°ng vá»›i DB thÃ¬ sao? ğŸ˜¬

âŒ **KhÃ´ng cÃ³ â€œmagicâ€**

Kafka **khÃ´ng thá»ƒ rollback DB** cho báº¡n.

â¡ï¸ Muá»‘n *end-to-end exactly-once*, báº¡n pháº£i tá»± xá»­ lÃ½.

### âœ… Pattern thÆ°á»ng dÃ¹ng
- Idempotent consumer
- Transactional Outbox
- Dedup table
- Unique business key

---

### 8ï¸âƒ£ Mapping sang Spring Kafka

ğŸ”¹ At-most-once

```yaml
enable-auto-commit: true
```

ğŸ”¹ At-least-once
```yaml
enable-auto-commit: false
ack-mode: RECORD

```

ğŸ”¹ Exactly-once (Kafka â†’ Kafka)
```yaml
spring.kafka.producer.transaction-id-prefix: tx-
spring.kafka.listener.ack-mode: MANUAL

```

---

### 9ï¸âƒ£ Káº¿t luáº­n Ä‘á»ƒ nhá»› lÃ¢u ğŸ§ 

- ğŸ”¸ **At-most-once**: nhanh â€“ cÃ³ thá»ƒ máº¥t
- ğŸ”¸ **At-least-once**: an toÃ n â€“ cÃ³ thá»ƒ trÃ¹ng
- ğŸ”¸ **Exactly-once**: ráº¥t khÃ³ â€“ chá»‰ *Kafka â†’ Kafka* lÃ  â€œchuáº©nâ€

---
## Kafka Transaction

# ğŸš€ Kafka Transactions lÃ  gÃ¬?

**Kafka Transactions** lÃ  cÆ¡ cháº¿ giÃºp Kafka Ä‘áº£m báº£o:

> Message Ä‘Æ°á»£c xá»­ lÃ½ vÃ  ghi ra topic khÃ¡c  
> â†’ **hoáº·c THÃ€NH CÃ”NG Táº¤T Cáº¢**  
> â†’ **hoáº·c KHÃ”NG CÃ“ GÃŒ Cáº¢**

ğŸ‘‰ Äáº£m báº£o **Atomic + Exactly-once** trong Kafka pipeline.

---

## 1ï¸âƒ£ Váº¥n Ä‘á» mÃ  Kafka Transactions giáº£i quyáº¿t

Giáº£ sá»­ flow phá»• biáº¿n:
```yaml
  Consume tá»« topic A
    â†“
  Xá»­ lÃ½
    â†“
  Produce sang topic B
    â†“
  Commit offset
```

### âŒ KhÃ´ng dÃ¹ng Transactions

| TÃ¬nh huá»‘ng | Káº¿t quáº£ |
|-----------|--------|
| Produce xong, crash trÆ°á»›c commit offset | Duplicate xá»­ lÃ½ |
| Commit offset xong, crash trÆ°á»›c produce | Máº¥t message |

â¡ï¸ **KhÃ´ng thá»ƒ Ä‘áº¡t exactly-once**

---

## 2ï¸âƒ£ Kafka Transactions lÃ m gÃ¬?

Kafka **gá»™p cÃ¡c hÃ nh Ä‘á»™ng sau vÃ o cÃ¹ng má»™t transaction**:

- Gá»­i message sang topic má»›i
- Commit offset cá»§a consumer

â¡ï¸ **Hoáº·c commit táº¥t cáº£, hoáº·c rollback táº¥t cáº£**

---

## 3ï¸âƒ£ Flow chuáº©n vá»›i Kafka Transactions
```yaml
beginTransaction()
  â†“
poll() tá»« topic A
  â†“
process()
  â†“
send() sang topic B
  â†“
sendOffsetsToTransaction()
  â†“
commitTransaction()
```

### ğŸ’¥ Náº¿u cÃ³ lá»—i á»Ÿ giá»¯a
```yaml
abortTransaction()
```

â¡ï¸ Consumer sáº½ Ä‘á»c láº¡i message  
â¡ï¸ Producer **KHÃ”NG bá»‹ duplicate**

## 4ï¸âƒ£ Cáº¥u hÃ¬nh báº¯t buá»™c

Producer
```yaml
enable.idempotence=true
transactional.id=my-tx-producer-1
```
ğŸ“Œ CÃ³ transactional.id â‡’ Kafka tá»± báº­t idempotent.

Consumer

```yaml
isolation.level=read_committed
enable.auto.commit=false
```

## 5ï¸âƒ£ transactional.id lÃ  gÃ¬?

- **ID duy nháº¥t** cho má»—i *logical producer*
- Kafka dÃ¹ng `transactional.id` Ä‘á»ƒ:
  - Track **transaction state**
  - **Fence producer cÅ©** (zombie producer)

### ğŸ’¥ TrÆ°á»ng há»£p nguy hiá»ƒm

Náº¿u **2 producer dÃ¹ng chung `transactional.id`**:
- Producer má»›i lÃªn sáº½ **fence producer cÅ©**
- Producer cÅ© **khÃ´ng thá»ƒ ghi tiáº¿p**

ğŸ‘‰ TrÃ¡nh tÃ¬nh tráº¡ng **ghi trÃ¹ng / ghi bá»«a** cá»±c ká»³ nguy hiá»ƒm

---

## 6ï¸âƒ£ Transactions Ä‘áº£m báº£o gÃ¬ & KHÃ”NG Ä‘áº£m báº£o gÃ¬?

### âœ… Äáº£m báº£o

| Pháº¡m vi | Exactly-once |
|------|-------------|
| Producer â†’ Broker | âœ… |
| Consume â†’ Process â†’ Produce | âœ… |
| Commit offset | âœ… |

### âŒ KHÃ”NG Ä‘áº£m báº£o

- Ghi DB ngoÃ i Kafka (MySQL, Redis, â€¦)
- Gá»i HTTP / external service

ğŸ‘‰ Muá»‘n **EOS vá»›i DB**:
- **Outbox Pattern**
- Hoáº·c **DB Transaction + CDC (Debezium)**

---

## 7ï¸âƒ£ So sÃ¡nh nhanh

| CÆ¡ cháº¿ | DÃ¹ng khi nÃ o |
|------|-------------|
| Idempotent Producer | Chá»‰ produce |
| Kafka Transactions | Consume â†’ Produce |
| Retry | LuÃ´n luÃ´n |
| Exactly-once end-to-end | Kafka-only pipeline |

---

## 8ï¸âƒ£ Khi nÃ o NÃŠN dÃ¹ng Kafka Transactions?

### âœ… NÃªn dÃ¹ng khi
- Kafka Streams
- Event processing pipeline
- ETL Kafka â†’ Kafka
- Financial / Order processing

### âŒ KhÃ´ng cáº§n khi
- Producer chá»‰ gá»­i **1 topic**
- Consumer chá»‰ Ä‘á»c & ghi DB

---

## 9ï¸âƒ£ Má»™t cÃ¢u Ä‘á»ƒ nhá»› ğŸ§ 

> **Kafka Transactions = exactly-once cho pipeline Kafka â†’ Kafka**

---
## Rebalance

## ğŸ”„ Kafka Rebalance lÃ  gÃ¬?

Trong Kafka, **rebalance** lÃ  quÃ¡ trÃ¬nh **phÃ¢n chia láº¡i cÃ¡c partition cho cÃ¡c consumer** trong cÃ¹ng má»™t consumer group khi cÃ³ sá»± thay Ä‘á»•i.

ğŸ‘‰ NÃ³i ngáº¯n gá»n: **Kafka pháº£i â€œchia láº¡i viá»‡câ€** ğŸ§ âš–ï¸

---

## ğŸ¯ Rebalance xáº£y ra khi nÃ o?

Rebalance sáº½ Ä‘Æ°á»£c trigger khi **cáº¥u trÃºc consumer group thay Ä‘á»•i**, vÃ­ dá»¥:

- â• CÃ³ consumer má»›i join group
- â– Consumer bá»‹ cháº¿t / disconnect
- ğŸ”„ Consumer restart
- ğŸ“ˆ Topic tÄƒng / giáº£m sá»‘ partition
- â±ï¸ Consumer khÃ´ng poll ká»‹p â†’ `session.timeout.ms`

---

## ğŸ”„ Rebalance diá»…n ra nhÆ° tháº¿ nÃ o?

### ğŸ‘‰ Quy trÃ¬nh Ä‘Æ¡n giáº£n

1. Táº¥t cáº£ consumer trong group **táº¡m dá»«ng Ä‘á»c**
2. Kafka **thu há»“i partition** tá»« consumer cÅ©
3. Kafka **assign láº¡i partition** cho cÃ¡c consumer
4. Consumer báº¯t Ä‘áº§u Ä‘á»c láº¡i tá»« **offset Ä‘Ã£ commit**

### ğŸ‘‰ Trong thá»i gian nÃ y
- âŒ Consumer **khÃ´ng xá»­ lÃ½ message**
- âŒ Náº¿u rebalance xáº£y ra nhiá»u:
    - Lag tÄƒng
    - Throughput giáº£m
    - Performance Ä‘i xuá»‘ng rÃµ rá»‡t

---

## ğŸ“¦ VÃ­ dá»¥ dá»… hiá»ƒu

Giáº£ sá»­:

- **Topic**: `order-topic` cÃ³ **6 partition**
- **Consumer group** cÃ³ **2 consumer**

### ğŸ”¹ TrÆ°á»›c khi rebalance
```text
Consumer-1 â†’ P0, P1, P2
Consumer-2 â†’ P3, P4, P5
```

â• ThÃªm consumer C

Rebalance xáº£y ra:

```text
Consumer A: P0, P1
Consumer B: P2, P3
Consumer C: P4, P5
```

â†’ Táº¥t cáº£ consumer stop â†’ reassign â†’ resume

## âš ï¸ Táº¡i sao Rebalance nguy hiá»ƒm?

Rebalance **khÃ´ng há» free**:

- âŒ Dá»«ng xá»­ lÃ½ message **táº¡m thá»i**
- âŒ CÃ³ thá»ƒ **xá»­ lÃ½ trÃ¹ng message** (do Kafka máº·c Ä‘á»‹nh *at-least-once*)
- âŒ Vá»›i há»‡ thá»‘ng **real-time** â†’ cá»±c ká»³ khÃ³ chá»‹u

ğŸ‘‰ **Rebalance storm = Ã¡c má»™ng** ğŸ˜µ

---

## ğŸ› ï¸ LÃ m sao Ä‘á»ƒ giáº£m Rebalance?

### 1ï¸âƒ£ TÄƒng timeout há»£p lÃ½
- CÃ¢n chá»‰nh:
- 
```yaml
session.timeout.ms=30000
max.poll.interval.ms=300000
```

- TrÃ¡nh consumer bá»‹ coi lÃ  *dead* khi xá»­ lÃ½ lÃ¢u

---

### 2ï¸âƒ£ Poll Ä‘á»u Ä‘áº·n
- KhÃ´ng xá»­ lÃ½ business logic quÃ¡ lÃ¢u trong `poll()`
- TÃ¡ch xá»­ lÃ½ náº·ng sang thread khÃ¡c náº¿u cáº§n

---

### 3ï¸âƒ£ DÃ¹ng Static Membership
ğŸ‘‰ Restart consumer **KHÃ”NG gÃ¢y rebalance**

```yaml
group.instance.id=consumer-1
```

- Set `group.instance.id`
- Giá»¯ assignment á»•n Ä‘á»‹nh giá»¯a cÃ¡c láº§n restart
- Tuy nhiÃªn, khÃ´ng dÃ¹ng vá»›i project
  - CÃ³ hÆ¡n 1 group-id trong project
  - CÃ³ concurrency > 1

---

### 4ï¸âƒ£ Chá»n assignor phÃ¹ há»£p

| Assignor | Äáº·c Ä‘iá»ƒm |
|--------|--------|
| `RangeAssignor` | Máº·c Ä‘á»‹nh, dá»… lá»‡ch táº£i |
| `RoundRobinAssignor` | Chia Ä‘á»u hÆ¡n |
| `CooperativeStickyAssignor` | âœ… Ãt giÃ¡n Ä‘oáº¡n nháº¥t |

ğŸ“Œ **Khuyáº¿n nghá»‹ PROD**: `CooperativeStickyAssignor`

---

### 1ï¸âƒ£ Static Membership lÃ  gÃ¬?

#### âŒ Máº·c Ä‘á»‹nh (Dynamic Membership)
Kafka **nháº­n diá»‡n consumer báº±ng `consumer.id` (random)**

- Restart consumer = **consumer má»›i**
- Kafka nghÄ©:
  > â€œÃ€ tháº±ng cÅ© cháº¿t rá»“i, tháº±ng má»›i vÃ oâ€
- ğŸ‘‰ **Rebalance toÃ n bá»™ consumer group**

---

#### âœ… Static Membership
Kafka **nháº­n diá»‡n consumer báº±ng `group.instance.id` (do báº¡n Ä‘áº·t)**

- Restart consumer = **váº«n lÃ  consumer cÅ©**
- Kafka **GIá»® partition**
- ğŸ‘‰ **KhÃ´ng rebalance**

ğŸ“Œ **NÃ³i ngáº¯n gá»n**:
> Restart **khÃ´ng Ä‘á»“ng nghÄ©a** vá»›i leave / join group

---

### âš ï¸ LÆ°u Ã½ Cá»°C Ká»² quan trá»ng

ğŸ”´ **`group.instance.id` PHáº¢I DUY NHáº¤T**

- Má»—i consumer â†’ **1 ID riÃªng**
- Kubernetes thÆ°á»ng map vá»›i:
  - `pod-name`
  - `hostname`
  - `instance-id`
- Tuy nhiÃªn, khÃ´ng dÃ¹ng vá»›i project
  - CÃ³ hÆ¡n 1 group-id trong project
  - CÃ³ concurrency > 1

âŒ **2 consumer cÃ¹ng `group.instance.id`**  
â¡ï¸ Kafka **Ä‘Ã¡ 1 tháº±ng ra ngoÃ i**

---

### âœ… Khi nÃ o nÃªn dÃ¹ng Static Membership?

- âœ… Consumer **restart thÆ°á»ng xuyÃªn**
- âœ… DÃ¹ng **Kubernetes / Docker / autoscaling**
- âœ… Muá»‘n **á»•n Ä‘á»‹nh partition assignment**

### âŒ Khi KHÃ”NG nÃªn dÃ¹ng
- âŒ Consumer ngáº¯n háº¡n (job cháº¡y xong lÃ  cháº¿t)

---

### 2ï¸âƒ£ Assignor lÃ  gÃ¬?

**Assignor** quyáº¿t Ä‘á»‹nh:
> Partition nÃ o â†’ consumer nÃ o

---

### ğŸ”¹ 1. RangeAssignor *(default cÅ©)*

- PhÃ¢n chia theo **range liÃªn tá»¥c**
- âŒ Dá»… **máº¥t cÃ¢n báº±ng** khi partition khÃ´ng chia háº¿t
- âŒ Rebalance kiá»ƒu **Eager** â†’ *stop toÃ n bá»™*

VÃ­ dá»¥

6 partition
3 consumer

```yaml
C1: P0, P1
C2: P2, P3
C3: P4, P5

```

---

### ğŸ”¹ 2. RoundRobinAssignor

- Chia Ä‘á»u theo **vÃ²ng trÃ²n**

```yaml
C1: P0, P3
C2: P1, P4
C3: P2, P5
```

- âœ… CÃ¢n hÆ¡n `RangeAssignor`
- âŒ Rebalance váº«n lÃ  **Eager** â†’ dá»«ng toÃ n bá»™

---

### ğŸ”¹ 3. StickyAssignor

ğŸ‘‰ Giá»¯ **partition cÅ© cÃ ng nhiá»u cÃ ng tá»‘t**

- Khi rebalance â†’ Ã­t thay Ä‘á»•i assignment
- Giáº£m:
  - Cache miss
  - Warm-up
- âŒ Váº«n lÃ  **Eager Rebalance**

---

### ğŸ”¹ 4. ğŸ† CooperativeStickyAssignor *(KhuyÃªn dÃ¹ng)*

> **ÄÃ¢y lÃ  chÃ¢n Ã¡i** â¤ï¸

### ğŸ”¥ KhÃ¡c biá»‡t lá»›n

| Eager Rebalance | Cooperative Rebalance |
|---------------|----------------------|
| Stop toÃ n bá»™ | Thu há»“i tá»«ng pháº§n |
| Assign láº¡i háº¿t | Chuyá»ƒn dáº§n |
| Lag spike | Lag tháº¥p |

ğŸ‘‰ **Consumer khÃ´ng cáº§n dá»«ng háº¿t** khi rebalance

VÃ­ dá»¥ cooperative

C1, C2 Ä‘ang cháº¡y

C3 join

```yaml
Step 1: C1 tráº£ P2
Step 2: C3 nháº­n P2
Step 3: CÃ¡c partition khÃ¡c váº«n xá»­ lÃ½
```
* âœ… KhÃ´ng pause toÃ n group
* âœ… Ráº¥t phÃ¹ há»£p há»‡ thá»‘ng lá»›n

### ğŸ§© Static Membership + Cooperative = Combo chuáº©n production

```yaml
group.id=order-consumer
group.instance.id=${HOSTNAME}
partition.assignment.strategy=org.apache.kafka.clients.consumer.CooperativeStickyAssignor
```
ğŸ¯ Káº¿t quáº£:

* Restart pod â†’ âŒ rebalance
* Scale consumer â†’ rebalance nháº¹
* Lag á»•n Ä‘á»‹nh
* Ãt duplicate message

---

## ğŸ§  Ghi nhá»› nhanh

- Static Membership â†’ **giáº£m rebalance khi restart**
- Assignor quyáº¿t Ä‘á»‹nh **Ä‘á»™ giÃ¡n Ä‘oáº¡n**
- **Best combo PROD**:
  - `group.instance.id`
  - `CooperativeStickyAssignor`

## Rebalance cÃ³ lÃ  1 quÃ¡ trÃ¬nh nÃªn can thiá»‡p khÃ´ng? 

ğŸ‘‰ **KHÃ”NG nÃªn â€œcan thiá»‡pâ€ vÃ o rebalance logic cá»§a Kafka**  
ğŸ‘‰ **NHÆ¯NG báº¯t buá»™c pháº£i â€œKIá»‚M SOÃTâ€ vÃ  â€œGIáº¢M TÃC Äá»˜NGâ€ cá»§a nÃ³**

---

## 1ï¸âƒ£ Rebalance cÃ³ pháº£i lÃ  thá»© cáº§n trÃ¡nh tuyá»‡t Ä‘á»‘i khÃ´ng?

âŒ **KhÃ´ng**

ğŸ‘‰ Rebalance lÃ  **cÆ¡ cháº¿ sá»‘ng cÃ²n** cá»§a Kafka:

- Consumer cháº¿t â†’ **pháº£i chia láº¡i**
- Scale up / down â†’ **pháº£i chia láº¡i**
- Topic Ä‘á»•i sá»‘ partition â†’ **pháº£i chia láº¡i**

â¡ï¸ **KhÃ´ng rebalance = há»‡ thá»‘ng khÃ´ng scale, khÃ´ng self-heal**

---

### 2ï¸âƒ£ Váº­y â€œcan thiá»‡pâ€ nghÄ©a lÃ  gÃ¬? *(KHÃ”NG NÃŠN)*

#### âŒ Nhá»¯ng thá»© KHÃ”NG nÃªn lÃ m
- âŒ Tá»± viáº¿t láº¡i thuáº­t toÃ¡n assign partition
- âŒ Hack consumer Ä‘á»ƒ giá»¯ partition báº±ng má»i giÃ¡
- âŒ Block rebalance Ä‘á»ƒ â€œÄ‘á»¡ lagâ€
- âŒ Delay join group thá»§ cÃ´ng

ğŸ‘‰ Háº­u quáº£:
- Vá»¡ Kafka protocol
- Dead consumer
- Offset sai
- Lag **ráº¥t khÃ³ debug**

---

### 3ï¸âƒ£ Thá»© NÃŠN lÃ m: **KIá»‚M SOÃT Rebalance**

Kafka cho phÃ©p báº¡n kiá»ƒm soÃ¡t á»Ÿ **3 level** ğŸ‘‡

---

#### ğŸ§© Level 1 â€“ Cáº¥u hÃ¬nh *(~80% hiá»‡u quáº£)*

> ÄÃ¢y lÃ  **quan trá»ng nháº¥t**

âœ… **Giáº£m rebalance vÃ´ nghÄ©a**
- Consumer xá»­ lÃ½ lÃ¢u â†’ Ä‘á»«ng Ä‘á»ƒ Kafka tÆ°á»Ÿng nÃ³ cháº¿t
- Poll Ä‘á»u Ä‘áº·n

âœ… **Static Membership**
- ğŸ‘‰ Restart **â‰  rebalance**

âœ… **Cooperative Rebalance**
- ğŸ‘‰ Rebalance **tá»«ng pháº§n**, khÃ´ng dá»«ng toÃ n bá»™

---

#### ğŸ§© Level 2 â€“ Quan sÃ¡t & Hook *(NÃŠN lÃ m)*

ğŸ‘‰ DÃ¹ng `ConsumerRebalanceListener`

- âœ… ÄÃ¢y lÃ  **can thiá»‡p AN TOÃ€N**
- âœ… KhÃ´ng thay Ä‘á»•i logic Kafka
- âœ… Chá»‰ dÃ¹ng Ä‘á»ƒ:
  - Chuáº©n bá»‹ trÆ°á»›c khi revoke
  - Dá»n dáº¹p sau khi assign

---

#### ğŸ§© Level 3 â€“ Kiáº¿n trÃºc *(PRO level)*

âŒ **Sai**
```text
concurrency = 10
1 pod (Kubernetes)
```
âœ… ÄÃºng

```text
concurrency = 1
10 pod (Kubernetes)
```

### 4ï¸âƒ£ Khi nÃ o Rebalance lÃ  â€œváº¥n Ä‘á»â€ tháº­t sá»±?

ğŸš¨ **Khi:**
- Rebalance xáº£y ra **liÃªn tá»¥c**
- Lag **spike** sau má»—i rebalance
- Message bá»‹ xá»­ lÃ½ **trÃ¹ng nhiá»u**
- Throughput **tá»¥t máº¡nh**

ğŸ‘‰ **Khi Ä‘Ã³:**
- âŒ **KHÃ”NG pháº£i lá»—i Kafka**
- âœ… LÃ  **config hoáº·c kiáº¿n trÃºc sai**

---

### 5ï¸âƒ£ Checklist quyáº¿t Ä‘á»‹nh nhanh

| Viá»‡c | CÃ³ nÃªn |
|----|--------|
| Táº¯t rebalance | âŒ |
| Hack Kafka | âŒ |
| Static membership | âœ… |
| Cooperative assignor | âœ… |
| Rebalance listener | âœ… |
| Scale báº±ng pod | âœ… |

---

### ğŸ§  Chá»‘t láº¡i 1 cÃ¢u

> **Rebalance lÃ  Ä‘á»‹nh má»‡nh** ğŸ˜„  
> Äá»«ng chá»‘ng láº¡i nÃ³ â€” **hÃ£y lÃ m cho nÃ³ nháº¹ nhÃ ng**

---

## Sync/Async

### 1. Producer: Sync vs Async
Máº·c Ä‘á»‹nh, `KafkaTemplate` cá»§a Spring hoáº¡t Ä‘á»™ng theo cÆ¡ cháº¿ **Async**. Tuy nhiÃªn, báº¡n cÃ³ thá»ƒ cáº¥u hÃ¬nh nÃ³ thÃ nh **Sync** tÃ¹y theo yÃªu cáº§u vá» Ä‘á»™ tin cáº­y.

#### âš¡ Async Producer (Máº·c Ä‘á»‹nh)
Khi gá»i `send()`, Spring Ä‘áº©y message vÃ o má»™t bá»™ Ä‘á»‡m (buffer) ná»™i bá»™ vÃ  tráº£ vá» quyá»n Ä‘iá»u khiá»ƒn cho luá»“ng (thread) hiá»‡n táº¡i ngay láº­p tá»©c.

* **CÆ¡ cháº¿:** Tráº£ vá» má»™t `CompletableFuture<SendResult>`. Báº¡n cÃ³ thá»ƒ Ä‘Äƒng kÃ½ callback (`whenComplete`) Ä‘á»ƒ xá»­ lÃ½ káº¿t quáº£.
* **Æ¯u Ä‘iá»ƒm:** Tá»‘c Ä‘á»™ cá»±c nhanh, khÃ´ng lÃ m ngháº½n á»©ng dá»¥ng (high throughput).
* **NhÆ°á»£c Ä‘iá»ƒm:** Dá»… máº¥t message náº¿u cÃ³ lá»—i phÃ¡t sinh mÃ  khÃ´ng xá»­ lÃ½ callback cáº©n tháº­n.

#### ğŸ”„ Sync Producer
Ã‰p á»©ng dá»¥ng pháº£i chá» Ä‘á»£i cho Ä‘áº¿n khi Kafka Broker xÃ¡c nháº­n Ä‘Ã£ nháº­n Ä‘Æ°á»£c message.

* **CÆ¡ cháº¿:** Gá»i phÆ°Æ¡ng thá»©c `.get()` trÃªn Ä‘á»‘i tÆ°á»£ng `CompletableFuture`.

```text
// á»¨ng dá»¥ng sáº½ dá»«ng láº¡i á»Ÿ Ä‘Ã¢y cho Ä‘áº¿n khi cÃ³ káº¿t quáº£ tá»« Broker
kafkaTemplate.send(topic, data).get(); 
```

* **Æ¯u Ä‘iá»ƒm:** Äáº£m báº£o tin nháº¯n Ä‘Ã£ Ä‘áº¿n Broker, phÃ¹ há»£p cho giao dá»‹ch tÃ i chÃ­nh quan trá»ng.
* **NhÆ°á»£c Ä‘iá»ƒm:** Giáº£m hiá»‡u suáº¥t Ä‘Ã¡ng ká»ƒ do thread bá»‹ cháº·n (blocking).

---

### 2. Consumer: Sync vs Async
á» phÃ­a Consumer, khÃ¡i niá»‡m nÃ y xoay quanh viá»‡c **XÃ¡c nháº­n Ä‘Ã£ Ä‘á»c (Acking/Committing Offsets)**.

#### âš¡ Async Consumer (Máº·c Ä‘á»‹nh)
Consumer xá»­ lÃ½ message vÃ  gá»­i tÃ­n hiá»‡u xÃ¡c nháº­n (commit offset) mÃ  khÃ´ng cáº§n Ä‘á»£i Broker pháº£n há»“i.

* **Äáº·c Ä‘iá»ƒm:** TÄƒng tá»‘c Ä‘á»™ vÃ²ng láº·p xá»­ lÃ½ (`poll loop`).
* **Rá»§i ro:** Náº¿u commit tháº¥t báº¡i mÃ  consumer váº«n cháº¡y tiáº¿p, cÃ³ thá»ƒ gÃ¢y láº·p dá»¯ liá»‡u hoáº·c máº¥t dáº¥u vá»‹ trÃ­ Ä‘á»c khi xáº£y ra sá»± cá»‘ (*rebalance*).

#### ğŸ”„ Sync Consumer
Consumer dá»«ng láº¡i vÃ  Ä‘á»£i Broker xÃ¡c nháº­n lÆ°u Offset thÃ nh cÃ´ng trÆ°á»›c khi xá»­ lÃ½ báº£n tin tiáº¿p theo.

* **Äáº·c Ä‘iá»ƒm:** ThÆ°á»ng cáº¥u hÃ¬nh qua `AckMode.MANUAL_SYNC`.
* **Æ¯u Ä‘iá»ƒm:** Kiá»ƒm soÃ¡t cá»±c ká»³ cháº·t cháº½ vá»‹ trÃ­ Ä‘á»c dá»¯ liá»‡u, trÃ¡nh máº¥t dáº¥u dá»¯ liá»‡u.

---

### ğŸ“Š So sÃ¡nh tá»•ng quan

| Äáº·c Ä‘iá»ƒm | Sync (Äá»“ng bá»™) | Async (Báº¥t Ä‘á»“ng bá»™) |
| :--- | :--- | :--- |
| **Tá»‘c Ä‘á»™** | Cháº­m (Latency cao) | Ráº¥t nhanh (Throughput cao) |
| **Äá»™ tin cáº­y** | Cao (Biáº¿t ngay náº¿u lá»—i) | Trung bÃ¬nh (Cáº§n xá»­ lÃ½ callback) |
| **Thread** | Bá»‹ cháº·n (Blocked) | KhÃ´ng bá»‹ cháº·n (Non-blocking) |
| **Sá»­ dá»¥ng khi** | Dá»¯ liá»‡u quan trá»ng, cáº§n thá»© tá»± | Log, dá»¯ liá»‡u lá»›n, cáº§n hiá»‡u suáº¥t |


## VÃ­ dá»¥ 
## HÆ°á»›ng dáº«n Ká»¹ thuáº­t: Kafka Producer & Consumer (Sync/Async)

TÃ i liá»‡u nÃ y hÆ°á»›ng dáº«n cÃ¡ch triá»ƒn khai cÃ¡c cÆ¡ cháº¿ gá»­i vÃ  nháº­n tin nháº¯n trong Kafka sá»­ dá»¥ng Spring Boot, bao gá»“m cáº£ hai cháº¿ Ä‘á»™ Äá»“ng bá»™ (Sync) vÃ  Báº¥t Ä‘á»“ng bá»™ (Async).

---

## 1. VÃ­ dá»¥ vá» Producer

### Async Producer (Sá»­ dá»¥ng Callback)
ÄÃ¢y lÃ  cÃ¡ch phá»• biáº¿n nháº¥t. Báº¡n gá»­i tin nháº¯n vÃ  tiáº¿p tá»¥c lÃ m viá»‡c khÃ¡c, khi nÃ o Kafka xong thÃ¬ nÃ³ tá»± bÃ¡o láº¡i qua `CompletableFuture`.

```java
    public void sendMessageAsync(String message) {
        CompletableFuture<SendResult<String, String>> future = kafkaTemplate.send("my-topic", message);

        // ÄÄƒng kÃ½ callback Ä‘á»ƒ xá»­ lÃ½ káº¿t quáº£ mÃ  khÃ´ng lÃ m block thread chÃ­nh
        future.whenComplete((result, ex) -> {
            if (ex == null) {
                System.out.println("Gá»­i thÃ nh cÃ´ng offset: " + result.getRecordMetadata().offset());
            } else {
                System.err.println("Gá»­i tháº¥t báº¡i: " + ex.getMessage());
            }
        });
        
        System.out.println("Thread chÃ­nh váº«n tiáº¿p tá»¥c cháº¡y...");
    }
   ```

### Sync Producer (DÃ¹ng `.get()`)
Sá»­ dá»¥ng khi báº¡n cáº§n Ä‘áº£m báº£o tin nháº¯n Ä‘Ã£ vÃ o hÃ ng chá» trÆ°á»›c khi thá»±c hiá»‡n bÆ°á»›c tiáº¿p theo (vÃ­ dá»¥: trá»« tiá»n xong má»›i bÃ¡o thÃ nh cÃ´ng).

```java
    public void sendMessageSync(String message) {
        try {
            // .get() sáº½ báº¯t thread hiá»‡n táº¡i dá»«ng láº¡i vÃ  chá» Ä‘á»£i pháº£n há»“i tá»« Kafka
            SendResult<String, String> result = kafkaTemplate.send("my-topic", message).get();
            System.out.println("XÃ¡c nháº­n Ä‘Ã£ gá»­i thÃ nh cÃ´ng: " + result.getRecordMetadata().offset());
        } catch (InterruptedException | ExecutionException e) {
            System.err.println("Lá»—i khi gá»­i Ä‘á»“ng bá»™: " + e.getMessage());
        }
    }
```

---

## 2. VÃ­ dá»¥ vá» Consumer (Sync/Async Commit)

Trong Spring Kafka, viá»‡c "Sync/Async" á»Ÿ Consumer thÆ°á»ng náº±m á»Ÿ cÃ¡ch báº¡n **Commit Offset** (xÃ¡c nháº­n Ä‘Ã£ Ä‘á»c). Báº¡n cáº§n cáº¥u hÃ¬nh `AckMode` trong `ConcurrentKafkaListenerContainerFactory`.

### Sync Commit 

#### 1. Cáº¥u hÃ¬nh thÃ´ng qua `application.yml`

Äá»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng Manual Commit, báº¡n cáº§n táº¯t cháº¿ Ä‘á»™ tá»± Ä‘á»™ng vÃ  Ä‘á»‹nh nghÄ©a cÃ¡ch thá»©c xÃ¡c nháº­n trong pháº§n `listener`.

```yaml
    spring:
      kafka:
        consumer:
          bootstrap-servers: localhost:9092
          group-id: my-group
          # Táº¯t cháº¿ Ä‘á»™ tá»± Ä‘á»™ng commit cá»§a Kafka Client thuáº§n
          enable-auto-commit: false 
          auto-offset-reset: earliest
          key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
          value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
        
        listener:
          # Cháº¿ Ä‘á»™ xÃ¡c nháº­n thá»§ cÃ´ng
          # MANUAL_SYNC: Commit Ä‘á»“ng bá»™ (Ä‘á»£i broker xÃ¡c nháº­n)
          # MANUAL: Commit báº¥t Ä‘á»“ng bá»™ (khÃ´ng Ä‘á»£i)
          ack-mode: manual_sync 
```

---

#### Giáº£i thÃ­ch cÃ¡c cháº¿ Ä‘á»™ `ack-mode` phá»• biáº¿n

Viá»‡c chá»n `ack-mode` quyáº¿t Ä‘á»‹nh tÃ­nh **Sync/Async** khi há»‡ thá»‘ng xÃ¡c nháº­n Ä‘Ã£ xá»­ lÃ½ xong tin nháº¯n.

* **`record`**: Tá»± Ä‘á»™ng commit ngay sau khi listener xá»­ lÃ½ xong tá»«ng báº£n ghi Ä‘Æ¡n láº» dÃ¹ láº§n poll Ä‘Ã³ poll bao nhiÃªn tin nháº¯n Ä‘i ná»¯a.
* **`batch`** (Máº·c Ä‘á»‹nh): Tá»± Ä‘á»™ng commit sau khi Ä‘Ã£ xá»­ lÃ½ toÃ n bá»™ danh sÃ¡ch báº£n ghi nháº­n Ä‘Æ°á»£c tá»« má»™t láº§n `poll()`.
* **`manual`**: Báº¡n chá»§ Ä‘á»™ng gá»i `ack.acknowledge()`. Spring sáº½ Ä‘Æ°a yÃªu cáº§u commit vÃ o hÃ ng Ä‘á»£i vÃ  gá»­i Ä‘i báº¥t Ä‘á»“ng bá»™ (**Async**) á»Ÿ láº§n poll tiáº¿p theo.
* **`manual_sync`**: Báº¡n gá»i `ack.acknowledge()`, Spring sáº½ gá»­i yÃªu cáº§u commit ngay láº­p tá»©c vÃ  dá»«ng thread Ä‘á»ƒ Ä‘á»£i (**Sync**) pháº£n há»“i tá»« Kafka Broker.

> **LÆ°u Ã½:** `manual_sync` lÃ  cháº¿ Ä‘á»™ an toÃ n nháº¥t Ä‘á»ƒ Ä‘áº£m báº£o dá»¯ liá»‡u khÃ´ng bá»‹ máº¥t dáº¥u offset, nhÆ°ng sáº½ cÃ³ Ä‘á»™ trá»… cao hÆ¡n so vá»›i `manual`.

---

#### TÃ³m táº¯t lá»±a chá»n

| Cháº¿ Ä‘á»™ | Loáº¡i | Äáº·c Ä‘iá»ƒm |
| :--- | :--- | :--- |
| **Manual** | Async | Hiá»‡u nÄƒng cao, khÃ´ng chá» Ä‘á»£i Broker xÃ¡c nháº­n. |
| **Manual Sync** | Sync | Äá»™ tin cáº­y tuyá»‡t Ä‘á»‘i, Ä‘áº£m báº£o Broker Ä‘Ã£ ghi nháº­n offset. |

#### Sá»­ dá»¥ng manual trong code
Khi dÃ¹ng cháº¿ Ä‘á»™ **Manual**, báº¡n sáº½ nháº­n Ä‘Æ°á»£c Ä‘á»‘i tÆ°á»£ng `Acknowledgment` Ä‘á»ƒ tá»± tay commit.

```java
    @KafkaListener(topics = "my-topic", groupId = "my-group")
    public void listen(String message, Acknowledgment ack) {
        try {
            System.out.println("Äang xá»­ lÃ½: " + message);
            // Giáº£ láº­p xá»­ lÃ½ logic...
            
            // Gá»i commit
            ack.acknowledge(); 
            // Náº¿u á»Ÿ trÃªn cáº¥u hÃ¬nh MANUAL_SYNC, dÃ²ng nÃ y sáº½ block thread cho Ä‘áº¿n khi commit xong.
        } catch (Exception e) {
            // Xá»­ lÃ½ lá»—i, khÃ´ng gá»i ack.acknowledge() Ä‘á»ƒ tin nháº¯n khÃ´ng bá»‹ máº¥t
        }
    }
```

LÆ°u Ã½ quan trá»ng:
* Enable-auto-commit: Pháº£i set lÃ  false thÃ¬ cáº¥u hÃ¬nh ack-mode cá»§a Spring má»›i cÃ³ tÃ¡c dá»¥ng thá»±c sá»± theo Ã½ muá»‘n thá»§ cÃ´ng cá»§a báº¡n.
* Hiá»‡u suáº¥t: manual_sync an toÃ n nhÆ°ng sáº½ lÃ m cháº­m tá»‘c Ä‘á»™ xá»­ lÃ½ cá»§a Consumer má»™t chÃºt vÃ¬ tá»‘n thá»i gian chá» Ä‘á»£i máº¡ng (network round-trip) cho má»—i láº§n commit.

---

## 3. Báº£ng so sÃ¡nh ká»‹ch báº£n sá»­ dá»¥ng

| Ká»‹ch báº£n | KhuyÃªn dÃ¹ng | LÃ½ do |
| :--- | :--- | :--- |
| **Gá»­i Log/Tracking** | `Async Producer` | Máº¥t vÃ i dÃ²ng log khÃ´ng quan trá»ng báº±ng viá»‡c lÃ m cháº­m há»‡ thá»‘ng. |
| **Giao dá»‹ch NgÃ¢n hÃ ng** | `Sync Producer` | Pháº£i cháº¯c cháº¯n dá»¯ liá»‡u Ä‘Ã£ vÃ o Kafka trÆ°á»›c khi bÃ¡o "ThÃ nh cÃ´ng" cho user. |
| **Xá»­ lÃ½ Data lá»›n** | `Async Commit` | Tá»‘i Æ°u tá»‘c Ä‘á»™ Ä‘á»c, cháº¥p nháº­n rá»§i ro xá»­ lÃ½ láº·p náº¿u crash. |
| **Xá»­ lÃ½ Ä‘Æ¡n hÃ ng** | `Sync Commit` | Äáº£m báº£o xá»­ lÃ½ xong cÃ¡i nÃ y má»›i qua cÃ¡i khÃ¡c, trÃ¡nh sai sÃ³t dá»¯ liá»‡u. |