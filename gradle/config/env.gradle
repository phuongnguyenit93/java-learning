apply from: "${rootDir}/gradle/config/module.gradle"

ext.buildProfileEnvStructure = {List<HashMap> envProps ->
    envProps.each {props ->
        File baseDir = props.get("ABSOLUTE_PATH") as File

        List<String> profiles = gradle.extensions.extraProperties.get("profiles") as List<String>

        File env = new File(baseDir, ".env")
        if (!env.exists()) env.createNewFile()

        profiles.each {profile ->
            File envProfile = new File(baseDir, ".env.${profile}")
            if (!envProfile.exists()) envProfile.createNewFile()
        }

    }
}

ext.generateEnvFile = { List<HashMap> modulePropsList, String serviceName ->
    def GREEN = "\u001B[32m"
    def YELLOW = "\u001B[33m"
    def RESET = "\u001B[0m"
    def BLUE = "\u001B[34m"
    def CYAN = "\u001B[36m"

    println "${BLUE}=================================================="
    println "üîç GENERATED V√Ä UPDATE N·ªòI DUNG ENV C·∫¶N CHO DOCKER-COMPOSE V√Ä APPLICATION.YML (KH√îNG T·ªîN H·∫†I FILE G·ªêC)"
    println "${BLUE}==================================================${RESET}"

    HashMap props = ext.getModulePropByServiceName(serviceName, modulePropsList)
    if (props == null || props.isEmpty()) return

    def moduleDir = props.ABSOLUTE_PATH
    List<String> profiles = gradle.extensions.extraProperties.get("profiles") as List<String>
    List<String> envProfile = profiles.collect{env -> ".env.${env}"} as List<String>
    def envFiles = [".env", *envProfile]

    println "${BLUE}üåê [ENV-SYNC]${RESET} ƒêang ƒë·ªìng b·ªô h√≥a m√¥i tr∆∞·ªùng cho: ${CYAN}${serviceName}${RESET}"

    // 1. Qu√©t Master Keys
    def masterKeys = [] as Set
    [file("${moduleDir}/src/main/resources/application.yml"), file("${moduleDir}/docker-compose.yml")].each { f ->
        if (f.exists()) {
            def matcher = (f.text =~ /\$\{\s*([A-Z0-9_]+)(?::.*)?\s*\}/)
            matcher.each { masterKeys << it[1] }
        }
    }
    println "   üß© T√¨m th·∫•y ${YELLOW}${masterKeys.size()}${RESET} bi·∫øn m√¥i tr∆∞·ªùng c·∫ßn thi·∫øt t·ª´ YAML/Docker."

    // 2. L·∫•y Map gi√° tr·ªã mu·ªën ƒë√®
    def overrideProps = project.ext.getModuleDependEnvPath(props, modulePropsList) ?: [:]

    // 3. X·ª≠ l√Ω t·ª´ng file
    envFiles.each { fileName ->
        def targetFile = file("${moduleDir}/${fileName}")
        def currentContent = [:]
        def updatedCount = 0

        if (targetFile.exists()) {
            targetFile.eachLine { line ->
                if (line.trim() && !line.startsWith("#") && line.contains("=")) {
                    def parts = line.split("=", 2)
                    currentContent[parts[0].trim()] = parts.length > 1 ? parts[1].trim() : ""
                }
            }
        }

        def newLines = [
                "# ----------------------------------------------------------------",
                "# Auto-generated for: ${serviceName}",
                "# Sync Date: ${new Date().format('yyyy-MM-dd HH:mm:ss')}",
                "# ----------------------------------------------------------------"
        ]

        masterKeys.sort().each { key ->
            def finalValue = ""
            def origin = ""

            if (overrideProps.containsKey(key)) {
                finalValue = overrideProps[key]
                origin = "[OVERRIDDEN]"
                updatedCount++
            } else if (currentContent.containsKey(key)) {
                finalValue = currentContent[key]
                origin = "[KEPT-OLD]"
            } else {
                origin = "[NEW-EMPTY]"
            }

            newLines << "${key}=${finalValue}"
        }

        targetFile.text = newLines.join("\n")
        println "   üìù ${GREEN}Generated:${RESET} ${fileName} (${masterKeys.size()} keys, ${updatedCount} auto-filled)"
    }

    // 4. Example file
    def exampleFile = file("${moduleDir}/.env.example")
    exampleFile.text = "# Sample values - Please fill manually\n" +
            masterKeys.sort().collect { "${it}=your-value-here" }.join("\n")

    println "${GREEN}‚úÖ Done!${RESET} File .env.example ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t c·∫•u tr√∫c m·ªõi nh·∫•t."
    println "--------------------------------------------------"
}

ext.getModuleDependEnvPath = { HashMap prop, List<HashMap> dirListProps ->
    def CYAN = "\u001B[36m"
    def RESET = "\u001B[0m"
    def YELLOW = "\u001B[33m"
    def GREEN = "\u001B[32m"
    def BLUE = "\u001B[34m"

    println "${BLUE}=================================================="
    println "üîç T√åM KI·∫æM V√Ä THI·∫æT L·∫¨P C√ÅC PATH C·ª¶A MODULE ƒê·ªÇ D√ôNG CHO DOCKER-COMPOSE"
    println "${BLUE}==================================================${RESET}"

    // 1. L·∫•y danh s√°ch service ph·ª• thu·ªôc
    List<String> microserviceList = prop.get("SERVICE_DEPEND")?.toString()?.split(',') as List<String> ?: []
    String moduleName = prop.get("SERVICE_NAME")

    // Th√™m ch√≠nh n√≥ v√†o danh s√°ch ƒë·ªÉ l·∫•y path c·ªßa ch√≠nh m√¨nh lu√¥n
    if (moduleName && !microserviceList.contains(moduleName)) {
        microserviceList.add(moduleName)
    }

    println "${CYAN}üîç [ENV-PATH]${RESET} ƒêang thu th·∫≠p ƒë∆∞·ªùng d·∫´n ph·ª• thu·ªôc cho: ${GREEN}${moduleName}${RESET}"

    // 2. L·ªçc th√¥ng tin props t·ª´ danh s√°ch t·ªïng
    List<HashMap> filterMicroserviceProps = ext.getModulePropByServiceNameList(microserviceList, dirListProps)
    HashMap moduleEnvPath = new HashMap()

    filterMicroserviceProps.each { service ->
        def sName = service.get("SERVICE_NAME")
        def absPath = service.get("ABSOLUTE_PATH")
        def jarPath = service.get("JAR_PATH")
        def modPath = service.get("MODULE_PATH")

        moduleEnvPath["${sName}_ABSOLUTE_PATH"] = absPath
        moduleEnvPath["${sName}_JAR_PATH"] = jarPath
        moduleEnvPath["${sName}_MODULE_PATH"] = modPath

        println "   + Found: ${YELLOW}${sName}${RESET} -> ${absPath}"
    }

    // Ki·ªÉm tra n·∫øu s·ªë l∆∞·ª£ng t√¨m th·∫•y √≠t h∆°n s·ªë l∆∞·ª£ng y√™u c·∫ßu
    if (filterMicroserviceProps.size() < microserviceList.size()) {
        println "   ${YELLOW}‚ö†Ô∏è  Warning:${RESET} M·ªôt s·ªë service ph·ª• thu·ªôc kh√¥ng t√¨m th·∫•y th√¥ng tin trong dirListProps!"
    }

    // D√≤ng t·ªïng k·∫øt cu·ªëi c√πng
    println "${GREEN}‚ú® [COMPLETED]${RESET} ƒê√£ thi·∫øt l·∫≠p th√†nh c√¥ng ${CYAN}${moduleEnvPath.size()}${RESET} bi·∫øn m√¥i tr∆∞·ªùng cho ${GREEN}${moduleName}${RESET}."
    println "${BLUE}--------------------------------------------------${RESET}\n"

    return moduleEnvPath
}
