ext.buildEnvStructure = {List<HashMap> dockerPropsList ->
    List<HashMap> filterProps = ext.filterFolderPropByKeyValue("BUILD_ENV_AUTO","true",dockerPropsList)

    dockerPropsList.each {prop ->
        def envBase = new File(prop.get("ABSOLUTE_PATH") as File, ".env.base")
        if (!envBase.exists()) envBase.createNewFile()

        def envDocker = new File(prop.get("ABSOLUTE_PATH") as File, ".env.docker")
        if (!envDocker.exists()) envDocker.createNewFile()
    }
}

ext.buildDockerEnv = {List<HashMap> dockerPropsList,List<HashMap> dirListProps ->
    dockerPropsList.each {prop ->
        boolean isDockerBuild = ['BUILD_ENV_AUTO', 'BUILD_DOCKER_ENV'].every { prop[it] == 'true' }

        if (isDockerBuild) {

            List<String> microserviceList = prop.get("DOCKER_ENV_MICROSERVICE_LIST")?.toString()?.split(',') as List<String> ?: []

            String moduleName = prop.get("SERVICE_NAME")
            if (moduleName != null || !moduleName.equals("")) microserviceList.add(moduleName)

            List<HashMap> filterMicroserviceProps = ext.filterFolderPropByServiceName(microserviceList,dirListProps)

            StringBuilder content = new StringBuilder("")

            content.append("PROJECT_ROOT=${rootDir.toString().replace("\\","/")}\n\n")
            filterMicroserviceProps.each {service ->
                content.append("# --- SERVICE_NAME: ${service.get("SERVICE_NAME")} ---\n")
                content.append("${service.get("SERVICE_NAME")}_ABSOLUTE_PATH=${service.get("ABSOLUTE_PATH")}\n")
                content.append("${service.get("SERVICE_NAME")}_JAR_PATH=${service.get("JAR_PATH")}\n")
                content.append("${service.get("SERVICE_NAME")}_MODULE_PATH=${service.get("MODULE_PATH")}\n")
                content.append("\n\n")
            }

            def targetEnvFile = new File(prop.get("ABSOLUTE_PATH") as File, ".env.docker")
            if (!targetEnvFile.exists()) targetEnvFile.createNewFile()
            targetEnvFile.text = content.toString()
        }
    }
}

ext.combineEnvAuto = {List<HashMap> dockerPropsList ->
    dockerPropsList.each {prop ->
        boolean isDockerCombine = ['BUILD_ENV_AUTO', 'COMBINE_ENV_AUTO'].every { prop[it] == 'true' }

        if (isDockerCombine) {
            def dockerEnv = new File(prop.get("ABSOLUTE_PATH") as File, ".env.docker")
            def baseEnv = new File(prop.get("ABSOLUTE_PATH") as File, ".env.base")
            def env = new File(prop.get("ABSOLUTE_PATH") as File, ".env")
            def exampleEnv = new File(prop.get("ABSOLUTE_PATH") as File, ".env.example")

            if (!env.exists()) env.createNewFile()
            if (!exampleEnv.exists()) exampleEnv.createNewFile()

            if (baseEnv.exists() && dockerEnv.exists()) {

                // ENV file
                String combinedContent = baseEnv.text + "\n" + dockerEnv.text
                env.text = combinedContent

                // ENV example file
                def props = new Properties()
                baseEnv.withInputStream { props.load(it) }
                dockerEnv.withInputStream { props.load(it) }

                def exampleContent = new StringBuilder()
                exampleContent.append("# Example Env - Do not input any value in here\n\n")

                props.keySet().sort().each { key ->
                    exampleContent.append("${key}=your_value_here\n")
                }

                exampleEnv.text = exampleContent.toString()

            } else {
                println "‚ùå Missing .env.base or .env.docker"
            }

        }
    }


}
