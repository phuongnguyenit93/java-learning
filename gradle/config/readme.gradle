apply from: "${rootDir}/gradle/config/module.gradle"

ext.buildReadmeEmptyFile = {List<HashMap> readmeProps ->
    readmeProps.each {props ->
        File baseDir = new File(rootDir,props.get("RELATIVE_PATH") as String)
        File readmeFile = new File(baseDir,"README.md")

        if (!readmeFile.exists()) readmeFile.createNewFile()
    }
}

ext.buildReadmeLanguageStructure = {List<HashMap> readmeProps ->
    readmeProps.each {props ->
        File baseDir = new File (rootDir,props.get("RELATIVE_PATH") as String)

        List<String> langList = props.get("README_LANGUAGE")?.toString()?.split(",")

        if (langList == null) return

        langList.each{lang ->
            File langDir = new File(baseDir,"readme/${lang}")
            File menuDir = new File(langDir,"menu")
            if (!menuDir.exists()) menuDir.mkdirs()

            ["BASE.md", "LIST.md"].each { fileName ->
                def file = new File(langDir, fileName)
                if (!file.exists()) {
                    file.createNewFile()
                }
            }
        }

        File readmeDir = new File(baseDir,"readme")

        if (readmeDir.exists()) {
            readmeDir.listFiles().each { file ->
                if (file.isDirectory() && !langList.contains(file.name)) {
                    file.deleteDir()
                }
            }
        }

    }
}

ext.buildReadmeByServiceName = { List<HashMap> folderPropsList, String serviceName ->
    def BLUE = "\u001B[34m"
    def BOLD = "\u001B[1m"
    def RESET = "\u001B[0m"
    def YELLOW = "\u001B[33m"
    def CYAN = "\u001B[36m"

    logger.lifecycle("${BLUE}${BOLD}==================================================")
    logger.lifecycle("üîç BUILD README.MD FILE FOR SERVICE: ${YELLOW}${serviceName}${RESET}")
    logger.lifecycle("${BLUE}==================================================${RESET}")

    // T√¨m c·∫•u h√¨nh trong list
    HashMap props = folderPropsList.find { p ->
        p.SERVICE_NAME == serviceName && p.BUILD_README == 'TRUE'
    }

    if (props == null) {
        logger.lifecycle("‚ö†Ô∏è  [SKIP] Service '${serviceName}' kh√¥ng ƒë∆∞·ª£c c·∫•u h√¨nh BUILD_README ho·∫∑c kh√¥ng t·ªìn t·∫°i.")
        return
    }

    def moduleName = props.get("MODULE_PATH")
    def moduleProject = project.project(":${moduleName}")
    def languages = props.get("README_LANGUAGE")?.toString()?.split(",") ?: []

    logger.lifecycle("üìç Found Module: ${CYAN}${moduleName}${RESET}")
    logger.lifecycle("üåê Languages to process: ${CYAN}${languages.join(', ')}${RESET}")

    languages.each { lang ->
        // G·ªçi c√°c h√†m con (c√°c h√†m n√†y ƒë√£ c√≥ log chi ti·∫øt b√™n trong)
        project.ext.generateReadMeMenuList(moduleProject.projectDir, lang.trim())
        project.ext.combineFinalReadme(moduleProject.projectDir, lang.trim())
    }

    logger.lifecycle("${BLUE}${BOLD}‚ú® Finished README process for ${serviceName}${RESET}\n")
}


ext.generateReadMeMenuList = {File projectDir,String language ->
    def GREEN = "\u001B[32m"
    def YELLOW = "\u001B[33m"
    def RESET = "\u001B[0m"
    def BLUE = "\u001B[34m"

    logger.lifecycle("${BLUE}üöÄ [START]${RESET} Generating Menu List for language: ${YELLOW}${language}${RESET} in ${projectDir.name}")
    def docsDir = new File("${projectDir}/readme/${language}")
    if (!docsDir.exists() || !docsDir.isDirectory()) {
        logger.lifecycle(">>>> ${YELLOW}Warning:${RESET} Th∆∞ m·ª•c 'docs' kh√¥ng t·ªìn t·∫°i t·∫°i: ${docsDir.path}")
        return
    }

    def listFile = file("${projectDir}/readme/${language}/LIST.md")
    def menuDir = file("${docsDir}/menu")

    // Ki·ªÉm tra xem folder menu c√≥ t·ªìn t·∫°i kh√¥ng tr∆∞·ªõc khi listFiles
    if (!menuDir.exists()) {
        logger.lifecycle(">>>> ${YELLOW}Skip:${RESET} Th∆∞ m·ª•c 'menu' kh√¥ng t√¨m th·∫•y t·∫°i: ${menuDir.path}")
        return
    }

    def menuFiles = menuDir.listFiles().findAll { it.name.endsWith('.md') }

    if (menuFiles.isEmpty()) {
        logger.lifecycle(">>>> ${YELLOW}Notice:${RESET} Kh√¥ng t√¨m th·∫•y file .md n√†o trong th∆∞ m·ª•c menu.")
    } else {
        logger.lifecycle("üìù ƒê√£ t√¨m th·∫•y ${YELLOW}${menuFiles.size()}${RESET} file Menu.")
    }

    menuFiles.sort { it.name }

    StringBuilder content = new StringBuilder()

    content.append("# MENU LIST \n\n")

    menuFiles.each { file ->
        def fileName = file.name.replace(".md", "")

        def relativePath = file.path
                .replace("${projectDir.path}${File.separator}","")
                .replace(File.separator,"/")
                .replace(" ","%20")

        content.append("* [${fileName}](${relativePath})\n")
    }

    listFile.text = content.toString()

    logger.lifecycle("${GREEN}‚úÖ [SUCCESS]${RESET} ƒê√£ c·∫≠p nh·∫≠t xong file: ${BLUE}${listFile.path}${RESET}")
    logger.lifecycle("--------------------------------------------------")
}

ext.combineFinalReadme = {File projectDir,String language ->
    def GREEN = "\u001B[32m"
    def YELLOW = "\u001B[33m"
    def RED = "\u001B[31m"
    def RESET = "\u001B[0m"
    def CYAN = "\u001B[36m"

    def basePath = "${projectDir}/readme/${language}"
    def basicFile = file("${basePath}/BASE.md")
    def listFile = file("${basePath}/LIST.md")

    def outputName = "README${language == "en" ? "" : ".${language}"}.md"
    def combineFile = file("${projectDir}/${outputName}")

    logger.lifecycle("${CYAN}üõ†Ô∏è  [COMBINING]${RESET} Preparing ${YELLOW}${outputName}${RESET} for module: ${CYAN}${projectDir.name}${RESET}")

// Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa c√°c file th√†nh ph·∫ßn
    boolean hasBase = basicFile.exists()
    boolean hasList = listFile.exists()

    if (hasBase && hasList) {
        // Th·ª±c hi·ªán g·ªôp file
        if (!combineFile.exists()) {
            combineFile.createNewFile()
            logger.lifecycle("   üìÑ File m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o: ${outputName}")
        }

        combineFile.text = basicFile.text + "\n\n" + listFile.text

        // Log b√°o c√°o k√≠ch th∆∞·ªõc file ƒë·ªÉ ng∆∞·ªùi d√πng an t√¢m
        def sizeKB = String.format("%.2f", combineFile.length() / 1024.0)
        logger.lifecycle("${GREEN}‚úÖ [SUCCESS]${RESET} ƒê√£ g·ªôp th√†nh c√¥ng v√†o: ${GREEN}${combineFile.name}${RESET} (${sizeKB} KB)")
    } else {
        // B√°o l·ªói chi ti·∫øt file n√†o b·ªã thi·∫øu
        logger.lifecycle("${RED}‚ùå [ERROR]${RESET} Kh√¥ng th·ªÉ g·ªôp file t·∫°i ${projectDir.name}:")
        if (!hasBase) logger.lifecycle("   - Thi·∫øu file: ${RED}${basicFile.path}${RESET}")
        if (!hasList) logger.lifecycle("   - Thi·∫øu file: ${RED}${listFile.path}${RESET}")
    }
    logger.lifecycle("--------------------------------------------------")

}